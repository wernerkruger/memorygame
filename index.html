<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Number Memory Game</title>
<link rel="stylesheet" href="styles.css">

<!-- Firebase setup -->
<script type="module" src="firebase.js"></script>
</head>
<body>

<div id="topButtons">
    <span class="topBtn" id="toggleSound">Sound: ON</span>
    <span class="topBtn" id="toggleTheme">Theme: Dark</span>
</div>

<div id="layout">

    <!-- LEFT: RANDOM HIGH SCORES -->
    <div id="leftBoard">
        <h2>Random Mode</h2>
        <h3>Top 10</h3>
        <table id="randomTable"></table>
    </div>

    <!-- CENTER: GAME -->
    <div id="gameContainer">
        <h1>Number Memory Game</h1>
        <div id="scores">
            Current Streak: <span id="currentStreak">0</span><br>
            Mode: <span id="modeLabel">Random</span>
        </div>
        <div id="grid"></div>
        <div id="message">Press START or PI</div>
    </div>

    <!-- RIGHT: PI HIGH SCORES -->
    <div id="rightBoard">
        <h2>PI Mode</h2>
        <h3>Top 10</h3>
        <table id="piTable"></table>
    </div>

</div>

<script type="module">
/* ---------------------------------------------------
   FIREBASE HIGH SCORE FUNCTIONS
--------------------------------------------------- */
const { collection, addDoc, getDocs, query, orderBy, limit } = window.firestoreTools;
const db = window.db;

async function fetchScores(mode) {
    const col = collection(db, mode === "pi" ? "highscores_pi" : "highscores_random");
    const q = query(col, orderBy("score", "desc"), limit(10));
    const snap = await getDocs(q);
    return snap.docs.map(d => d.data());
}

async function submitScore(score, mode) {
    const name = prompt("You made the top 10! Enter your name:") || "Anonymous";
    const col = collection(db, mode === "pi" ? "highscores_pi" : "highscores_random");

    await addDoc(col, { name, score });
    await loadAndRenderTables();
}

function renderTable(id, list) {
    const t = document.getElementById(id);
    t.innerHTML = "<tr><th>Name</th><th>Score</th></tr>" +
        list.map(x => `<tr><td>${x.name}</td><td>${x.score}</td></tr>`).join("");
}

async function loadAndRenderTables() {
    const rand = await fetchScores("random");
    const pi = await fetchScores("pi");
    renderTable("randomTable", rand);
    renderTable("piTable", pi);
}
loadAndRenderTables();

/* ---------------------------------------------------
   SOUND + THEME
--------------------------------------------------- */
let soundEnabled = JSON.parse(localStorage.getItem("soundEnabled") ?? "true");
let theme = localStorage.getItem("theme") || "dark";
document.body.classList.toggle("light", theme === "light");

document.getElementById("toggleTheme").textContent =
    theme === "light" ? "Theme: Light" : "Theme: Dark";

document.getElementById("toggleSound").textContent =
    soundEnabled ? "Sound: ON" : "Sound: OFF";

document.getElementById("toggleTheme").onclick = () => {
    theme = theme === "dark" ? "light" : "dark";
    localStorage.setItem("theme", theme);
    document.body.classList.toggle("light", theme === "light");
    document.getElementById("toggleTheme").textContent =
        theme === "light" ? "Theme: Light" : "Theme: Dark";
};

document.getElementById("toggleSound").onclick = () => {
    soundEnabled = !soundEnabled;
    localStorage.setItem("soundEnabled", soundEnabled);
    document.getElementById("toggleSound").textContent =
        soundEnabled ? "Sound: ON" : "Sound: OFF";
};

function playBeepForDigit(d) {
    if (!soundEnabled) return;
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.frequency.value = 300 + d * 80;
    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
    osc.stop(ctx.currentTime + 0.35);
}

/* ---------------------------------------------------
   GAME LOGIC
--------------------------------------------------- */
const grid = document.getElementById("grid");
const message = document.getElementById("message");
const modeLabel = document.getElementById("modeLabel");
const currentStreakEl = document.getElementById("currentStreak");

let sequence = [];
let userIndex = 0;
let acceptingInput = false;
let currentStreak = 0;
let piMode = false;

const PI_DIGITS = "31415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819";  

// Build grid
[...Array(10).keys()].forEach(n => {
    const c = document.createElement("div");
    c.className = "cell";
    c.textContent = n;
    c.dataset.value = n;
    grid.appendChild(c);
});
function addButton(id, label) {
    const b = document.createElement("div");
    b.className = "cell";
    b.id = id;
    b.textContent = label;
    grid.appendChild(b);
}
addButton("start", "Start");
addButton("piModeButton", "PI");
addButton("reset", "Reset");

const allCells = document.querySelectorAll(".cell");

function flashCell(cell) {
    return new Promise(res => {
        cell.classList.add("flash");
        playBeepForDigit(Number(cell.dataset.value));
        setTimeout(() => {
            cell.classList.remove("flash");
            setTimeout(res, 150);
        }, 450);
    });
}

async function playSequence() {
    acceptingInput = false;
    for (let d of sequence) {
        const cell = [...allCells].find(c => c.dataset.value == d);
        await flashCell(cell);
    }
    acceptingInput = true;
    message.textContent = "Repeat the sequence!";
}

function addDigit() {
    let next = piMode
        ? Number(PI_DIGITS[sequence.length])
        : Math.floor(Math.random() * 10);

    sequence.push(next);
    currentStreak = sequence.length - 1;
    currentStreakEl.textContent = currentStreak;

    playSequence();
}

function startGame(random = true) {
    piMode = !random;
    modeLabel.textContent = piMode ? "PI" : "Random";

    sequence = [];
    userIndex = 0;
    currentStreak = 0;
    currentStreakEl.textContent = 0;

    message.textContent = piMode ? "PI Mode" : "Random Mode";
    addDigit();
}

function resetGame() {
    sequence = [];
    userIndex = 0;
    currentStreak = 0;
    currentStreakEl.textContent = 0;
    acceptingInput = false;
    message.textContent = "Game reset.";
}

// Click handling
grid.addEventListener("click", (e) => {
    const cell = e.target;
    const val = cell.dataset.value;
    if (!val || !acceptingInput) return;

    playBeepForDigit(Number(val));

    if (Number(val) === sequence[userIndex]) {
        userIndex++;
        if (userIndex === sequence.length) {
            userIndex = 0;
            message.textContent = "Correct!";
            setTimeout(addDigit, 700);
        }
    } else {
        acceptingInput = false;
        message.textContent = `Wrong! Final streak: ${currentStreak}`;
        submitScore(currentStreak, piMode ? "pi" : "random");
    }
});

document.getElementById("start").onclick = () => startGame(true);
document.getElementById("piModeButton").onclick = () => startGame(false);
document.getElementById("reset").onclick = () => resetGame();

</script>

</body>
</html>
